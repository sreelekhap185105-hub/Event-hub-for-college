<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Events - Event Management</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&family=Poppins:wght@600;800&display=swap" rel="stylesheet">
<style>
:root {
  --bg: #f6f0ff; --card:#fff; --text:#333;
  --nav-text:#4e54c8; --primary:#4e54c8; --primary-light:#8f94fb;
  --timer-bg:#d5eadb; --timer-text:#1da73d;
}

/* site dark theme variables */
.dark-theme {
  --bg:#1c1e26; --card:#2a2d38; --text:#e6e6e6; --nav-text:#b7bcff;
  --primary:#7d83ff; --primary-light:#acb1ff; --timer-bg:#2f4f39; --timer-text:#7dffae;
}

/* HERO + layout */
.hero{width:100vw;left:50%;transform:translateX(-50%);position:relative;height:260px;border-radius:10px;overflow:hidden;margin-bottom:1.2rem;box-shadow:0 8px 20px rgba(0,0,0,0.12)}
.hero-img{width:100%;height:100%;object-fit:cover;object-position:50% 20%;filter:brightness(55%) blur(1.2px);display:block}
.hero-overlay{position:absolute;inset:0;background:linear-gradient(to bottom, rgba(0,0,0,0.2), rgba(0,0,0,0.45));z-index:1}
.hero-text{position:absolute;bottom:70px;left:50%;transform:translateX(-50%);font-size:3rem;font-weight:800;font-family:'Poppins',sans-serif;color:#fff;white-space:nowrap;letter-spacing:3px;word-spacing:18px;text-transform:uppercase;z-index:2;opacity:0;animation:fadeUp 1.1s ease-out forwards}
@keyframes fadeUp{0%{opacity:0;transform:translate(-50%,22px)}100%{opacity:1;transform:translate(-50%,0)}}
.top-row{max-width:1200px;margin:1rem auto 2rem auto;display:flex;align-items:center;gap:1rem;padding:0 1rem}
.top-row .left,.top-row .right{flex:0 0 auto;display:flex;align-items:center}
.top-row .center{flex:1 1 auto;text-align:center}
.theme-toggle{display:inline-block;background:var(--card);padding:0.5rem 1.2rem;border-radius:20px;cursor:pointer;font-weight:700;color:var(--primary);box-shadow:0 5px 15px rgba(0,0,0,0.08);border:none;transition:0.25s}
.theme-toggle:hover{background:var(--primary);color:#fff}

/* Profile container adjusted for left/right layout */
.profile{
  display:flex;
  align-items:center;
  gap:0.6rem;
  background:var(--card);
  padding:0.45rem 0.9rem;
  border-radius:50px;
  box-shadow:0 5px 15px rgba(0,0,0,0.08);
  width:100%;
  justify-content:space-between; /* distribute left profile and right controls */
}

/* small left-block to group image+name */
.profile .left-block{
  display:flex;
  align-items:center;
  gap:10px;
}

/* keep image, name, and logout styles */
.profile img{width:38px;height:38px;border-radius:50%}
.profile span{font-weight:600;color:var(--primary)}
.profile button{padding:0.28rem 0.7rem;border:none;border-radius:24px;cursor:pointer;background:var(--primary);color:#fff;font-weight:600;transition:0.2s}
.profile button:hover{background:var(--primary-light)}
.profile .badge{display:inline-flex;align-items:center;justify-content:center;min-width:20px;height:20px;padding:0 6px;border-radius:999px;background:#e74c3c;color:#fff;font-size:12px;font-weight:700;margin-left:6px;cursor:pointer;box-shadow:0 6px 18px rgba(0,0,0,0.08)}

/* coordinators trigger/button */
.coordinators-wrap{margin-top:0.6rem;display:flex;justify-content:flex-end}
.coordinators-btn{background:var(--card);border-radius:14px;padding:0.45rem 0.9rem;box-shadow:0 6px 18px rgba(0,0,0,0.06);cursor:pointer;font-weight:700;color:var(--primary);border:none}
.coordinators-btn:hover{background:var(--primary);color:#fff}

/* coordinators panel base */
.coordinators-panel{position:absolute;right:1.25rem;top:calc(2rem + 72px);width:420px;background:var(--card);border-radius:12px;box-shadow:0 12px 40px rgba(0,0,0,0.12);padding:0.6rem;display:none;z-index:50}
.coordinators-panel.active{display:block}
.coord-item{display:flex;gap:0.6rem;align-items:center;justify-content:space-between;padding:0.45rem;border-radius:8px;cursor:pointer}
.coord-item:hover{background:rgba(0,0,0,0.03)}
.coord-item img{width:54px;height:54px;border-radius:8px;object-fit:cover}
.coord-item .meta{font-size:0.92rem;flex:1;margin-left:0.6rem}
.coord-item .meta .name{font-weight:700;color:var(--primary)}
.coord-item .meta .role{font-weight:600;color:var(--text);font-size:0.85rem}
.coord-preview{margin-top:0.6rem;display:flex;gap:0.6rem;align-items:center;padding:0.5rem;border-radius:8px;background:rgba(0,0,0,0.02)}
.coord-preview img{width:70px;height:70px;border-radius:10px;object-fit:cover}
.coord-preview .desc{font-size:0.95rem; color:var(--text)}

/* chat inside panel */
.chat-panel{display:none;flex-direction:column;gap:8px;margin-top:8px;border-top:1px solid rgba(0,0,0,0.06);padding-top:8px}
.chat-messages{max-height:220px;overflow:auto;display:flex;flex-direction:column;gap:8px;padding-right:6px}
.msg{padding:8px 10px;border-radius:10px;max-width:80%;line-height:1.2;font-size:0.95rem}
.msg.out{align-self:flex-end;background:var(--primary);color:#fff}
.msg.in{align-self:flex-start;background:rgba(0,0,0,0.06);color:var(--text)}
.chat-input{display:flex;gap:8px;margin-top:6px}
.chat-input textarea{flex:1;min-height:40px;max-height:90px;resize:none;padding:8px;border-radius:8px;border:1px solid rgba(0,0,0,0.06)}
.chat-input button{padding:8px 12px;border-radius:8px;border:none;cursor:pointer;background:var(--primary);color:#fff}

/* message button (default) inside coordinator items */
.coord-item .message-btn {
  padding:6px 10px;
  border-radius:8px;
  border:1px solid rgba(0,0,0,0.08);
  background:transparent;
  color:var(--primary);
  font-weight:700;
  cursor:pointer;
}

/* Inverted-panel styles:
   - when site is LIGHT, panel should be DARK -> .coordinators-panel.inverted-dark
   - when site is DARK, panel should be LIGHT -> .coordinators-panel.inverted-light
*/

/* DARK PANEL (for when site is light) */
.coordinators-panel.inverted-dark {
  background: #0f1113;
  color: #fff;
  box-shadow: 0 20px 60px rgba(0,0,0,0.45);
}
.coordinators-panel.inverted-dark .coord-item:hover { background: rgba(255,255,255,0.03); }

/* critical: ensure all text inside is visible */
.coordinators-panel.inverted-dark .coord-item .meta .name { color: #ffd966; }        /* name */
.coordinators-panel.inverted-dark .coord-item .meta .role { color: rgba(255,255,255,0.85); } /* role */
.coordinators-panel.inverted-dark .coord-preview .desc { color: rgba(255,255,255,0.9); }

/* message button styling for dark panel (so it's visible) */
.coordinators-panel.inverted-dark .message-btn {
  background: transparent;
  color: #ffffff;
  border: 1px solid rgba(255,255,255,0.12);
  box-shadow: none;
}

/* chat message colors on dark panel */
.coordinators-panel.inverted-dark .msg.in { background: rgba(255,255,255,0.06); color: #fff; }
.coordinators-panel.inverted-dark .msg.out { background: #7d83ff; color: #fff; }
.coordinators-panel.inverted-dark .chat-input textarea { background: rgba(255,255,255,0.04); color: #fff; border: 1px solid rgba(255,255,255,0.06); }

/* ensure images show clearly (keep same) */
.coordinators-panel.inverted-dark img { filter: none; }

/* LIGHT PANEL (for when site is dark) */
.coordinators-panel.inverted-light {
  background: #ffffff;
  color: #111;
  box-shadow: 0 12px 40px rgba(0,0,0,0.12);
}
.coordinators-panel.inverted-light .coord-item .meta .name { color: var(--primary); }
.coordinators-panel.inverted-light .coord-item .meta .role { color: rgba(0,0,0,0.75); }
.coordinators-panel.inverted-light .coord-preview .desc { color: rgba(0,0,0,0.8); }
.coordinators-panel.inverted-light .message-btn { color: var(--primary); border: 1px solid rgba(0,0,0,0.06); background: transparent; }

/* teacher inbox + rest left unchanged */
.inbox-panel{position:absolute;right:1.25rem;top:10px;width:420px;background:var(--card);border-radius:12px;box-shadow:0 12px 40px rgba(0,0,0,0.12);padding:0.6rem;z-index:60;display:none}
.inbox-panel.active{display:block}
.inbox-panel.dark{background:#0f1113;color:#fff;box-shadow:0 20px 60px rgba(0,0,0,0.45)}
.inbox-panel.dark .inbox-item{border-bottom:1px solid rgba(255,255,255,0.04)}
.inbox-item{padding:0.6rem;border-bottom:1px solid rgba(0,0,0,0.04)}
.inbox-item .from{font-weight:700;color:var(--primary)}
.inbox-item .time{font-size:0.82rem;color:rgba(0,0,0,0.5);margin-left:6px}
.inbox-panel.dark .inbox-item .from{color:#ffd966}
.inbox-panel.dark .inbox-item .time{color:rgba(255,255,255,0.6)}

@media (max-width:700px){.top-row{flex-direction:column;gap:0.8rem}.events-title{font-size:1.8rem}.hero-text{font-size:1.8rem;bottom:60px;white-space:normal;text-align:center}.coordinators-panel{right:0.75rem;left:0.75rem;top:calc(2rem + 140px)}.inbox-panel{right:0.75rem;left:0.75rem;top:10px}}
body{font-family:'Inter',sans-serif;background:var(--bg);padding:2rem;position:relative;color:var(--text);transition:0.3s ease}
nav{display:flex;gap:1rem;margin-bottom:2rem;justify-content:center;flex-wrap:wrap}
nav a{text-decoration:none;color:var(--nav-text);font-weight:600;padding:0.5rem 1rem;border-radius:10px;transition:0.3s;background:var(--card);box-shadow:0 5px 15px rgba(0,0,0,0.1)}
nav a:hover{background:var(--primary);color:#fff}
.add-event-btn{display:inline-block;margin-bottom:1.5rem;padding:0.6rem 1.2rem;background:var(--primary);color:#fff;border:none;border-radius:50px;font-weight:600;cursor:pointer;transition:0.3s}
.add-event-btn:hover{background:var(--primary-light)}
#eventsContainer{display:grid;grid-template-columns:repeat(2,1fr);gap:5.5rem;max-width:800px;margin:0 auto}
@media(max-width:700px){#eventsContainer{grid-template-columns:1fr;max-width:100%;padding:0 1rem}}
.event-card{background:var(--card);border-radius:10px;box-shadow:0 10px 20px rgba(0,0,0,0.1);overflow:hidden;display:flex;flex-direction:column;transition:0.3s;max-width:380px;margin:0 auto}
.event-card:hover{transform:translateY(-5px)}
.event-card img{width:100%;height:180px;object-fit:cover;border-radius:10px}
.event-card .content{padding:0.8rem 1rem 1rem 1rem;flex-grow:1;display:flex;flex-direction:column}
.event-card h3{font-size:1.6rem;margin-bottom:0.4rem;margin-top:-0.3rem;color:var(--primary);text-align:center}
.event-card p{color:var(--text);font-size:1.2rem;margin:0;line-height:1.3}
.event-card .event-detail{margin-bottom:0.2rem}
.event-card .event-detail strong{color:var(--text)}
.event-card .timer{margin-top:0.3rem;font-weight:600;color:var(--timer-text);font-size:1rem;text-align:center;background:var(--timer-bg);padding:0.2rem 0.5rem;border-radius:8px}
.event-card button{padding:0.4rem 0.8rem;border:none;border-radius:50px;font-weight:600;cursor:pointer;transition:0.3s;margin-right:0.3rem;font-size:0.85rem}
.book-btn{background:var(--primary);color:#fff}
.book-btn:hover{background:var(--primary-light)}
.edit-btn{background:#ffa500;color:#fff}
.edit-btn:hover{background:#ffb84d}
.delete-btn{background:#e74c3c;color:#fff}
.delete-btn:hover{background:#ff6659}
.event-actions{margin-top:0.8rem;display:flex;gap:0.3rem;flex-wrap:wrap}
</style>
</head>
<body>

<!-- HERO -->
<div class="hero" aria-hidden="true">
  <img src="cllg.png" alt="Campus" class="hero-img">
  <div class="hero-overlay"></div>
  <div class="hero-text">Akshaya Institute of Technology</div>
</div>

<!-- TOP ROW -->
<div class="top-row">
  <div class="left">
    <button class="theme-toggle" id="themeToggle">Theme</button>
  </div>

  <div class="center">
    <h1 class="events-title">Upcoming Events !</h1>
  </div>

  <div class="right" style="position:relative; display:flex; flex-direction:column; align-items:flex-start; gap:6px;">

    <!-- PROFILE BAR: image+name on left, logout + badge on right -->
    <div class="profile" id="profile" style="width:100%;">
      <div class="left-block">
        <img src="https://cdn-icons-png.flaticon.com/512/3135/3135715.png" alt="Profile Picture">
        <span id="profileName"></span>
      </div>

      <div class="right-block" style="display:flex;align-items:center;gap:8px;">
        <span id="notifBadge" class="badge" title="Messages" style="display:none;cursor:pointer;">0</span>
        <button id="logoutBtn">Logout</button>
      </div>
    </div>

    <!-- COORDINATORS BUTTON BELOW LOGOUT -->
    <div class="coordinators-wrap" aria-hidden="false" style="margin-top:0;">
      <button class="coordinators-btn" id="coordinatorsBtn">Co-ordinators ▾</button>
    </div>

    <div class="coordinators-panel" id="coordinatorsPanel" role="dialog" aria-label="Co-ordinators">
      <div id="coordList"></div>

      <div id="coordPreview" class="coord-preview" style="display:none;">
        <img id="previewImg" src="" alt="Coordinator">
        <div class="desc" id="previewDesc"></div>
      </div>

      <!-- inline chat area (appears when Message clicked) -->
      <div class="chat-panel" id="chatPanel">
        <div class="chat-messages" id="chatMessages"></div>
        <div class="chat-input">
          <textarea id="chatText" placeholder="Type your message..."></textarea>
          <button id="chatSend">Send</button>
        </div>
      </div>
    </div>

    <!-- teacher inbox panel -->
    <div class="inbox-panel" id="inboxPanel" aria-label="Inbox">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px;">
        <strong style="color:var(--primary);">Inbox</strong>
        <button id="closeInbox" style="background:transparent;border:none;cursor:pointer;font-weight:700;color:rgba(0,0,0,0.6);">Close</button>
      </div>
      <div id="inboxListArea" style="max-height:320px; overflow:auto;"></div>
      <div style="text-align:right;margin-top:8px;">
        <button id="markReadBtn" style="background:#e74c3c;color:#fff;border:none;padding:6px 10px;border-radius:8px;cursor:pointer;">Mark all read</button>
      </div>
    </div>

  </div>
</div>

<nav id="navbar"></nav>
<div id="teacherControls"></div>
<div id="eventsContainer"></div>

<script>
/* THEME TOGGLE + coordinators panel inversion sync */
/* when site is light -> coordinators panel should be dark
   when site is dark -> coordinators panel should be light
*/
const themeKey = "eventTheme";
if(localStorage.getItem(themeKey) === "dark") document.body.classList.add("dark-theme");

function syncCoordPanelTheme(){
  const panel = document.getElementById('coordinatorsPanel');
  if(!panel) return;
  panel.classList.remove('inverted-dark','inverted-light');
  if(document.body.classList.contains('dark-theme')){
    // site is dark => panel should be light
    panel.classList.add('inverted-light');
  } else {
    // site is light => panel should be dark
    panel.classList.add('inverted-dark');
  }
}

// initial sync on DOM ready
document.addEventListener('DOMContentLoaded', ()=>{ syncCoordPanelTheme(); });

// theme toggle handler (keeps localStorage behavior) and sync dropdown
document.getElementById("themeToggle").onclick = function(){
  document.body.classList.toggle("dark-theme");
  localStorage.setItem(themeKey, document.body.classList.contains("dark-theme") ? "dark" : "light");
  syncCoordPanelTheme();
};

/* ORIGINAL CODE — unchanged (logic preserved) */
const username = localStorage.getItem('username');
const role = localStorage.getItem('role');
if(!username || !role){ window.location.href='login.html'; }
document.getElementById('profileName').innerText = username;
document.getElementById('logoutBtn').addEventListener('click', ()=>{
  localStorage.removeItem('username'); localStorage.removeItem('role'); window.location.href='login.html';
});
const navbar = document.getElementById('navbar');
if(role==='teacher'){
  navbar.innerHTML = `<a href="events.html">Events</a><a href="bookings.html">All Bookings</a><a href="analytics.html">analytics</a><a href="scanner.html">QR Scanner</a><a href="simple_messaging.html">Group Chat</a>`;
} else {
  navbar.innerHTML = `<a href="events.html">Events</a><a href="bookings.html">My Bookings</a><a href="profile.html">Profile</a><a href="simple_messaging.html">Group Chat</a>`;
}
let events = JSON.parse(localStorage.getItem('eventsList')) || [];
function updateTimers(){
  document.querySelectorAll('.event-card').forEach((card,index)=>{ 
    const timerEl = card.querySelector('.timer'); if(!timerEl) return;
    const event = events[index]; const now = new Date(); const eventDate = new Date(`${event.date}T${event.time}`); let diff = eventDate - now;
    if(diff<=0) timerEl.innerText = "Event started!"; else {
      let days = Math.floor(diff/1000/60/60/24);
      let hours = Math.floor((diff/1000/60/60)%24);
      let seconds = Math.floor((diff/1000)%60);
      timerEl.innerText = `Starts in: ${days}d ${hours}h  ${seconds}s`;
    }
  });
}
function renderEvents(){
  const container = document.getElementById('eventsContainer'); container.innerHTML='';
  events.forEach((event,index)=>{
    const card = document.createElement('div'); card.classList.add('event-card');
    const eventImage = event.image && event.image.trim()!=='' ? event.image : 'https://source.unsplash.com/400x200/?event';
    let actionsHTML='';
    if(role==='student') actionsHTML = `<div class="event-actions"><button class="book-btn">Book Now</button></div>`;
    else if(role==='teacher') actionsHTML = `<div class="event-actions"><button class="edit-btn">Edit</button><button class="delete-btn">Delete</button></div>`;

    card.innerHTML=`
      <img src="${eventImage}" alt="${event.name}">
      <div class="content">
        <h3>${event.name}</h3>
        <p class="event-detail"><strong>Description:</strong> ${event.description}</p>
        <p class="event-detail"><strong>Date:</strong> ${event.date}</p>
        <p class="event-detail"><strong>Time:</strong> ${event.time}</p>
        <p class="event-detail"><strong>Venue:</strong> ${event.venue}</p>
        <div class="timer">Loading timer...</div>
        ${actionsHTML}
      </div>
    `;
    container.appendChild(card);

    if(role==='student'){
      card.querySelector('.book-btn').addEventListener('click', ()=>{ localStorage.setItem('selectedEvent',JSON.stringify(event)); localStorage.setItem('studentName',username); window.location.href='booking-form.html'; });
    }
    if(role==='teacher'){
      card.querySelector('.edit-btn').addEventListener('click', ()=>{ localStorage.setItem('editEventIndex',index); window.location.href='add-event.html'; });
      card.querySelector('.delete-btn').addEventListener('click', ()=>{ if(confirm(`Are you sure you want to delete "${event.name}"?`)){ events.splice(index,1); localStorage.setItem('eventsList',JSON.stringify(events)); renderEvents(); } });
    }
  });
  updateTimers();
  setInterval(updateTimers,1000);
}
renderEvents();
if(role==='teacher'){
  const teacherDiv = document.getElementById('teacherControls');
  const addBtn = document.createElement('button');
  addBtn.classList.add('add-event-btn'); addBtn.innerText = "Add New Event";
  teacherDiv.appendChild(addBtn);
  addBtn.addEventListener('click',()=>{ window.location.href='add-event.html'; });
}

/* ===== Messaging logic: store messages with from/to, and filter when students view ===== */
(function(){
  const coords = [
    { name: 'ashwini', role: 'Coordinator', img: 'ash.jpg' },
    { name: 'lakshmi', role: 'Coordinator', img: 'lax.jpg' },
    { name: 'lavanya', role: 'coding club Coordinator', img: 'lav.jpg' },
    { name: 'vinutha', role: 'coding club Coordinator', img: 'vinu.jpg' },
    { name: 'thrupti', role: 'Coordinator', img: 'trup.jpg' }
  ];

  const btn = document.getElementById('coordinatorsBtn');
  const panel = document.getElementById('coordinatorsPanel');
  const list = document.getElementById('coordList');
  const chatPanel = document.getElementById('chatPanel');
  const chatMessages = document.getElementById('chatMessages');
  const chatText = document.getElementById('chatText');
  const chatSend = document.getElementById('chatSend');
  const notifBadge = document.getElementById('notifBadge');

  function loadMessages(){ return JSON.parse(localStorage.getItem('messages') || '{}'); }
  function saveMessages(obj){ localStorage.setItem('messages', JSON.stringify(obj)); }
  function loadUnread(){ return JSON.parse(localStorage.getItem('unread') || '{}'); }
  function saveUnread(obj){ localStorage.setItem('unread', JSON.stringify(obj)); }

  // populate the coordinators list
  coords.forEach((c, idx)=>{
    const el = document.createElement('div');
    el.className = 'coord-item';
    el.innerHTML = `
      <div style="display:flex;align-items:center;flex:1;">
        <img src="${c.img}" alt="${c.name}">
        <div class="meta">
          <div class="name">${c.name}</div>
          <div class="role">${c.role}</div>
        </div>
      </div>
      <div style="margin-left:8px;display:flex;gap:6px;align-items:center;">
        <button class="message-btn" data-name="${c.name}" aria-label="Message ${c.name}">Message</button>
      </div>
    `;
    el.addEventListener('click', (e)=>{
      const target = e.target;
      if(target && target.classList.contains('message-btn')) return;
      const preview = document.getElementById('coordPreview');
      const previewImg = document.getElementById('previewImg');
      previewImg.src = c.img; previewImg.alt = c.name; preview.style.display = 'flex';
      panel.classList.add('active');
    });
    list.appendChild(el);
  });

  // delegate message button clicks
  list.addEventListener('click', (e)=>{
    const btnEl = e.target.closest('.message-btn');
    if(!btnEl) return;
    const teacherName = btnEl.dataset.name;
    if(role !== 'student') return;
    openChatFor(teacherName);
  });

  // open chat for teacher (student)
  let activeTeacher = null;
  function openChatFor(teacherName){
    activeTeacher = teacherName;
    panel.classList.add('active');
    chatPanel.style.display = 'flex';
    renderChatMessages();
    setTimeout(()=>chatText.focus(),50);
  }

  // render messages for the active student <-> activeTeacher only
  function renderChatMessages(){
    chatMessages.innerHTML = '';
    if(!activeTeacher) return;
    const msgsObj = loadMessages();
    const arr = msgsObj[activeTeacher] || [];
    // filter messages to only show messages that belong to this student <-> teacher thread
    const thread = arr.filter(m => {
      // message from this student to teacher OR from teacher to this student
      return (m.from === username && m.to === activeTeacher) || (m.from === activeTeacher && m.to === username);
    });
    thread.forEach(m => {
      const d = document.createElement('div');
      d.className = 'msg ' + (m.from === username ? 'out' : 'in');
      d.innerText = m.text;
      chatMessages.appendChild(d);
    });
    chatMessages.scrollTop = chatMessages.scrollHeight;
  }

  // send message (student) - message stored with from/to
  chatSend.addEventListener('click', ()=>{
    if(!activeTeacher) return;
    const text = chatText.value.trim();
    if(!text) return;
    const msgsObj = loadMessages();
    if(!msgsObj[activeTeacher]) msgsObj[activeTeacher] = [];
    // store message with from/to so we can filter threads
    msgsObj[activeTeacher].push({ from: username, to: activeTeacher, text, time: new Date().toISOString() });
    saveMessages(msgsObj);
    // increment unread for teacher
    const unread = loadUnread();
    unread[activeTeacher] = (unread[activeTeacher]||0) + 1;
    saveUnread(unread);
    updateBadge();
    chatText.value = '';
    renderChatMessages();
    // auto-close the coordinators panel per your previous request
    panel.classList.remove('active');
    chatPanel.style.display = 'none';
    activeTeacher = null;
    // small non-blocking visual indicator
    const sentNote = document.createElement('div'); sentNote.style.position='fixed'; sentNote.style.right='18px'; sentNote.style.bottom='18px'; sentNote.style.background='#1c7c54'; sentNote.style.color='#fff'; sentNote.style.padding='6px 10px'; sentNote.style.borderRadius='8px'; sentNote.style.fontSize='13px'; sentNote.style.zIndex='9999'; sentNote.innerText='Sent';
    document.body.appendChild(sentNote);
    setTimeout(()=>{ sentNote.remove(); },700);
  });

  // robust toggle / click handlers (prevent bubbling issues)
  btn.addEventListener('click', (e)=>{ e.stopPropagation(); panel.classList.toggle('active'); if(!panel.classList.contains('active')){ document.getElementById('coordPreview').style.display='none'; chatPanel.style.display='none'; activeTeacher=null; chatText.value=''; } });
  panel.addEventListener('click', (e)=>{ e.stopPropagation(); });
  notifBadge && notifBadge.addEventListener('click', (e)=>{ e.stopPropagation(); });

  document.addEventListener('click', (e)=>{
    const target = e.target;
    if(target.closest && (target.closest('#coordinatorsBtn') || target.closest('#coordinatorsPanel') || target.closest('.coordinators-btn'))) return;
    panel.classList.remove('active');
    const preview = document.getElementById('coordPreview'); if(preview) preview.style.display='none';
    chatPanel.style.display='none'; activeTeacher=null; chatText.value='';
  });

  function updateBadge(){
    const badge = document.getElementById('notifBadge');
    const unread = loadUnread();
    const count = Object.keys(unread).reduce((s,k)=> s + (unread[k]||0), 0);
    if(count>0 && role==='teacher'){ badge.style.display='inline-flex'; badge.innerText = count; } else { badge.style.display='none'; }
  }
  updateBadge();

  // sync panel theme initially in case DOMContentLoaded already fired before this IIFE
  syncCoordPanelTheme();
})();

/* Teacher inbox: show all messages addressed to them (messages stored under messages[teacherName]) */
(function(){
  const badge = document.getElementById('notifBadge');
  const inbox = document.getElementById('inboxPanel');
  const inboxListArea = document.getElementById('inboxListArea');
  const markReadBtn = document.getElementById('markReadBtn');
  const closeInbox = document.getElementById('closeInbox');

  function loadMessages(){ return JSON.parse(localStorage.getItem('messages')||'{}'); }
  function loadUnread(){ return JSON.parse(localStorage.getItem('unread')||'{}'); }
  function saveUnread(u){ localStorage.setItem('unread', JSON.stringify(u)); }

  badge.addEventListener('click', (e)=>{
    e.stopPropagation();
    if(role!=='teacher') return;
    inboxListArea.innerHTML = '';
    const msgs = loadMessages();
    const my = msgs[username] || []; // all messages stored under teacher's key
    if(my.length === 0){
      inboxListArea.innerHTML = '<div style="padding:12px;color:rgba(0,0,0,0.6);">No messages</div>';
      inbox.classList.remove('dark');
    } else {
      inbox.classList.add('dark');
      // show messages in reverse (newest first)
      my.slice().reverse().forEach(m=>{
        // show the sender and text — teacher sees who sent it via m.from
        const el = document.createElement('div'); el.className = 'inbox-item';
        const time = new Date(m.time).toLocaleString();
        el.innerHTML = `<div><span class="from">${m.from}</span><span class="time">${time}</span></div><div style="margin-top:6px;">${m.text}</div>`;
        inboxListArea.appendChild(el);
      });
    }
    inbox.classList.add('active');
  });

  closeInbox.addEventListener('click', ()=>{ inbox.classList.remove('active'); inbox.classList.remove('dark'); });

  markReadBtn.addEventListener('click', ()=>{
    const unread = loadUnread();
    delete unread[username];
    saveUnread(unread);
    document.getElementById('notifBadge').style.display='none';
    inbox.classList.remove('active');
    inbox.classList.remove('dark');
  });

  // initialize badge on load
  (function init(){
    const unread = loadUnread();
    const count = (unread[username]||0);
    const badgeElem = document.getElementById('notifBadge');
    if(count>0 && role==='teacher'){ badgeElem.style.display='inline-flex'; badgeElem.innerText = count; } else { badgeElem.style.display='none'; }
  })();

  // clicking outside inbox closes it
  document.addEventListener('click', (e)=>{
    const target = e.target;
    if(target.closest && (target.closest('#inboxPanel') || target.closest('#notifBadge'))) return;
    inbox.classList.remove('active'); inbox.classList.remove('dark');
  });
})();

/* chatbase snippet preserved */
(function(){if(!window.chatbase||window.chatbase("getState")!=="initialized"){window.chatbase=(...arguments)=>{if(!window.chatbase.q){window.chatbase.q=[]}window.chatbase.q.push(arguments)};window.chatbase=new Proxy(window.chatbase,{get(target,prop){if(prop==="q"){return target.q}return(...args)=>target(prop,...args)}})}const onLoad=function(){const script=document.createElement("script");script.src="https://www.chatbase.co/embed.min.js";script.id="4pUPZjw5PbV7YYMLi9Ngu";script.domain="www.chatbase.co";document.body.appendChild(script)};if(document.readyState==="complete"){onLoad()}else{window.addEventListener("load",onLoad)}})();
</script>
</body>
</html>
