<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Booking Confirmation</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
<style>
  body{font-family:Inter,Arial;background:#f6f7fb;padding:24px;display:flex;justify-content:center}
  .card{background:#fff;padding:20px;border-radius:12px;max-width:920px;width:100%;box-shadow:0 10px 30px rgba(2,6,23,0.06)}
  h2{margin:0 0 8px}
  .muted{color:#6b7280}
  .details p{margin:6px 0}
  .group-list > div{padding:8px;border-radius:8px;margin-bottom:6px;background:#fbfdff;border:1px solid #eef2ff}
  #qrcode{display:flex;justify-content:center;margin:12px 0}
  .controls{display:flex;gap:8px;justify-content:space-between;align-items:center;margin-bottom:12px}
  button{padding:8px 10px;border-radius:10px;border:none;background:#4e54c8;color:white;cursor:pointer;font-weight:700}
  button.ghost{background:#fff;color:#0f172a;border:1px solid #e6e9f2}
  pre.debug{background:#0b1220;color:#e6eef8;padding:12px;border-radius:8px;margin-top:12px;display:none;max-height:360px;overflow:auto}
  .list { margin-top:12px; }
  .list-item { padding:10px; border-radius:8px; background:#fff; border:1px solid #eef2ff; margin-bottom:8px; display:flex; justify-content:space-between; align-items:center; gap:12px; }
  .label{font-weight:700}
</style>
<script src="https://cdn.jsdelivr.net/npm/qrcode/build/qrcode.min.js"></script>
</head>
<body>
  <div class="card" role="main" aria-labelledby="title">
    <div class="controls">
      <div><span class="label">Booking lookup:</span> <span id="lookupText" class="muted">...</span></div>
      <div style="margin-left:auto">
        <button id="debugToggle" class="ghost">Toggle debug</button>
        <button id="downloadBtn">Download QR</button>
      </div>
    </div>

    <h2 id="title">Booking Confirmation</h2>

    <div id="chooserArea" class="list" aria-live="polite" style="display:none">
      <p class="muted">Multiple bookings found. Click one to view:</p>
      <div id="bookingChoices"></div>
    </div>

    <div id="details" class="details" aria-live="polite" style="display:none"></div>

    <div id="groupDiv" style="display:none;margin-top:12px">
      <h3 style="margin:6px 0">Group members</h3>
      <div id="membersList" class="group-list"></div>
    </div>

    <div id="qrcode" aria-hidden="true"></div>

    <div style="margin-top:12px">
      <button id="back" class="ghost">Back to bookings</button>
    </div>

    <pre id="debugPanel" class="debug"></pre>
  </div>

<script>
  function getParam(n){ try { return new URLSearchParams(location.search).get(n); } catch(e){ return null; } }
  function safe(v){ return (v === null || typeof v === 'undefined') ? '' : String(v); }
  function pretty(o){ try { return JSON.stringify(o,null,2); } catch(e) { return String(o); } }

  const selectedEvent = JSON.parse(localStorage.getItem('selectedEvent') || 'null');
  const registrationsList = JSON.parse(localStorage.getItem('registrationsList') || '[]');
  const storedBookings = JSON.parse(localStorage.getItem('bookingsList') || '[]');

  const lookupText = document.getElementById('lookupText');
  const debugToggle = document.getElementById('debugToggle');
  const debugPanel = document.getElementById('debugPanel');
  const downloadBtn = document.getElementById('downloadBtn');
  const back = document.getElementById('back');

  const chooserArea = document.getElementById('chooserArea');
  const bookingChoices = document.getElementById('bookingChoices');
  const details = document.getElementById('details');
  const groupDiv = document.getElementById('groupDiv');
  const membersList = document.getElementById('membersList');
  const qDiv = document.getElementById('qrcode');

  back.addEventListener('click', ()=> window.location.href = 'bookings.html');
  debugToggle.addEventListener('click', ()=> debugPanel.style.display = debugPanel.style.display === 'none' ? 'block' : 'none');
  debugPanel.textContent = 'selectedEvent:\\n' + pretty(selectedEvent) + '\\n\\nregistrationsList:\\n' + pretty(registrationsList) + '\\n\\nbookingsList:\\n' + pretty(storedBookings);

  function exactLookupById(id){
    if (!id) return null;
    return storedBookings.find(b => (b.bookingId === id) || (b.qrCode === id)) ||
           storedBookings.find(b => (b.bookingId && b.bookingId.toLowerCase()===id.toLowerCase()) || (b.qrCode && b.qrCode.toLowerCase()===id.toLowerCase()));
  }

  function bookingsForCurrentUserAndEvent(){
    let auth = {};
    try { auth = JSON.parse(localStorage.getItem('auth') || '{}'); } catch(e){ auth = {}; }
    const username = (localStorage.getItem('username') || (auth.user && auth.user.name) || '').toString().trim();
    const userEmail = ((auth.user && auth.user.email) || localStorage.getItem('userEmail') || '').toString().trim();
    function sameEvent(b){ if (!selectedEvent) return true; if (selectedEvent.id) return b.eventId && b.eventId === selectedEvent.id; if (selectedEvent.name) return b.event && b.event === selectedEvent.name; return true; }
    return storedBookings.filter(b => { if (!sameEvent(b)) return false; if (userEmail && b.email && b.email.toLowerCase()===userEmail.toLowerCase()) return true; if (username && b.student && b.student.toLowerCase()===username.toLowerCase()) return true; return false; });
  }

  function resolveGroupMembersFromBooking(booking){
    if (!booking) return [];
    if (Array.isArray(booking.groupMembers) && booking.groupMembers.length) return booking.groupMembers;
    const candidates = registrationsList.filter(r => {
      if (!r) return false;
      const eMatch = (() => { if (booking.eventId && r.eventId) return booking.eventId === r.eventId; if (booking.event && r.event) return booking.event === r.event; if (selectedEvent && r.eventId) return selectedEvent.id && r.eventId && selectedEvent.id === r.eventId; return true; })();
      if (!eMatch) return false;
      const bGroup = booking.groupName || booking.rawGroupName || '';
      if (bGroup && (r.groupName === bGroup || r.rawGroupName === bGroup)) return true;
      return Array.isArray(r.members) && r.members.some(m => (m.email && booking.email && m.email.toLowerCase() === booking.email.toLowerCase()) || (m.name && booking.student && m.name.toLowerCase() === booking.student.toLowerCase()));
    });
    if (candidates.length) return candidates[0].members || [];
    return [];
  }

  function showBooking(booking, reason){
    chooserArea.style.display = 'none';
    details.style.display = '';
    lookupText.textContent = reason || 'found';
    const bid = booking.bookingId || booking.qrCode || '';
    details.innerHTML = `
      <p><strong>Event:</strong> ${safe(booking.event || (selectedEvent && selectedEvent.name) || '')}</p>
      <p><strong>Name:</strong> ${safe(booking.student || '')}</p>
      <p><strong>Email:</strong> ${safe(booking.email || '-')}</p>
      <p><strong>Phone:</strong> ${safe(booking.phone || '-')}</p>
      <p><strong>Date:</strong> ${safe(booking.date || (selectedEvent && selectedEvent.date) || '-')}</p>
      <p><strong>Time:</strong> ${safe(booking.time || (selectedEvent && selectedEvent.time) || '-')}</p>
      <p><strong>Venue:</strong> ${safe(booking.venue || (selectedEvent && selectedEvent.venue) || '-')}</p>
      <p><strong>Booking ID:</strong> ${safe(bid)}</p>
    `;
    const members = resolveGroupMembersFromBooking(booking);
    if (Array.isArray(members) && members.length) {
      groupDiv.style.display = 'block';
      membersList.innerHTML = members.map(m => `<div><strong>${safe(m.name)}</strong>${m.email ? ' — ' + safe(m.email) : ''}${m.phone ? ' — ' + safe(m.phone) : ''}</div>`).join('');
    } else { groupDiv.style.display = 'none'; membersList.innerHTML = ''; }
    const payload = JSON.stringify({ bookingId: bid, event: booking.event || (selectedEvent && selectedEvent.name) || '', group: booking.groupName || booking.rawGroupName || '' });
    qDiv.innerHTML = '';
    QRCode.toCanvas(payload, { width:220 }).then(canvas => qDiv.appendChild(canvas)).catch(e => qDiv.textContent = payload);
    downloadBtn.onclick = ()=>{ const canvas = qDiv.querySelector('canvas'); if (!canvas) { alert('QR not ready'); return; } const url = canvas.toDataURL('image/png'); const a = document.createElement('a'); a.href = url; a.download = `${(booking.student||'booking')}_QR.png`; a.click(); };
  }

  function showChooser(list){
    bookingChoices.innerHTML = ''; chooserArea.style.display = ''; details.style.display = 'none'; lookupText.textContent = 'multiple_matches';
    list.forEach(b => {
      const item = document.createElement('div'); item.className = 'list-item';
      item.innerHTML = `<div><div style="font-weight:700">${safe(b.student)}</div><div class="muted">${safe(b.email||'-')} • ${safe(b.event||'')}</div></div><div><button data-id="${safe(b.bookingId||b.qrCode||'')}">View</button></div>`;
      bookingChoices.appendChild(item);
      item.querySelector('button').addEventListener('click', e => {
        const id = e.target.getAttribute('data-id');
        const selected = exactLookupById(id);
        if (selected) showBooking(selected, 'chosen_by_user');
      });
    });
  }

  (function main(){
    const bookingIdParam = getParam('booking_id');
    if (bookingIdParam) {
      const exact = exactLookupById(bookingIdParam);
      if (exact) { showBooking(exact, 'found_by_param'); return; }
      lookupText.textContent = 'param_not_found';
    }
    const userList = bookingsForCurrentUserAndEvent();
    if (userList.length === 1) { showBooking(userList[0], 'found_by_user_one_match'); return; }
    else if (userList.length > 1) { showChooser(userList); return; }
    const eventMatches = (selectedEvent && selectedEvent.id) ? storedBookings.filter(b => b.eventId === selectedEvent.id) : (selectedEvent && selectedEvent.name) ? storedBookings.filter(b => b.event === selectedEvent.name) : [];
    if (eventMatches.length === 1) {
      if (!confirm('Only one booking found for this event — show it?')) { showChooser(storedBookings.slice(-6).reverse()); return; }
      showBooking(eventMatches[0], 'found_by_event_single'); return;
    } else if (eventMatches.length > 1) { showChooser(eventMatches); return; }
    if (storedBookings.length) {
      if (confirm('No booking id provided and no user-specific bookings found. Show the latest booking?')) { showBooking(storedBookings[storedBookings.length - 1], 'fallback_latest'); return; }
      else { showChooser(storedBookings.slice(-8).reverse()); return; }
    }
    details.style.display = ''; details.innerHTML = '<p style="color:#ef4444;font-weight:700">No bookings found in storage.</p>'; lookupText.textContent = 'no_bookings';
  })();
</script>
</body>
</html>
